@{
    Layout = "_Admin.cshtml";
    Login AdminLogin = new Login();
    int reqLangID = 0;
    if (Request.QueryString["Lang"] != null)
    {
        reqLangID = Request.QueryString["Lang"].AsInt();
    }
    MvcXmlEntities ConnXml = new MvcXmlEntities();
    Setting Setting = ConnXml.Setting.FirstOrDefault();
    #region Değişkenler
    var txtTitle = "";
    var txtDate = "";
    var txtDesc = "";
    var txtContents = "";
    var lstPhotoGalery = "0";
    var txtRawUrl = "";
    int txtLine = 0;
    var drpLang = reqLangID.ToString();
    bool drpPageStatus = true;
    var fuImageUrl = "";
    var btnName = "Kaydet";
    var txtPageTitle = "Etkinlik Ekle";
    #endregion
    if (Request.QueryString["Delete"].IsInt())
    {
        int reqID = Request.QueryString["Delete"].AsInt();
        Events Pages = ConnXml.Events.FirstOrDefault(x => x.EventsID == reqID);
        string imgDir = "~/" + Setting.Documentdir + "/Events/" + Pages.ImageUrl;
        if (System.IO.File.Exists(Server.MapPath(imgDir)) && !Pages.ImageUrl.IsEmpty())
        {
            System.IO.File.Delete(Server.MapPath(imgDir));
        }
        ConnXml.Entry(Pages).State = System.Data.EntityState.Deleted;
        int ConnStatus = 0;
        ConnStatus = ConnXml.SaveChanges();
        if (ConnStatus > 0)
        {
            Session["Ok"] = "İşlem başarı ile gerçekleşmiştir.";
        }
        else
        {
            Session["Error"] = "Bir problem oldu yönetici ile görüşün.";
        }
        Response.Redirect("EventsPage?Lang=" + reqLangID);
    }
    if (Request.QueryString["ID"].IsInt() || Request.QueryString["HistoryID"].IsInt())
    {
        int reqID = Request.QueryString["ID"].AsInt();
        int historyID = (Request.QueryString["HistoryID"].AsInt());
        Events reqPage = new Events();
        if (reqID > 0)
        {
            reqPage = ConnXml.Events.FirstOrDefault(x => x.EventsID == reqID);
        }
        else if (historyID > 0)
        {
            reqPage = ConnXml.EventsHistory.FirstOrDefault(x => x.EventsHistoryID == historyID).Cast<Events>();
            btnName = "Geçmişe Dön";
            txtPageTitle = reqPage.Title + " adlı menü'nün " + reqPage.ModifiedDate + " tarihinde kaydedilen versiyonu. (Geçmişe dönmeden düzenleme yapamazsınız)";
        }
        txtTitle = reqPage.Title;
        txtDate = reqPage.Date.ToString("dd/MM/yyyy").Replace(".", "/");
        drpPageStatus = reqPage.Status;
        txtDesc = reqPage.Description;
        txtContents = reqPage.Contents;
        lstPhotoGalery = reqPage.PhotoGaleryID.ToString();
        txtRawUrl = reqPage.RawUrl;
        drpLang = reqPage.Lang.ToString();
        if (!reqPage.ImageUrl.IsEmpty())
        {
            string imgDir = "~/" + Setting.Documentdir + "/Events/" + reqPage.ImageUrl;
            if (System.IO.File.Exists(Server.MapPath(imgDir)))
            {
                fuImageUrl = "<div class=\"Input\"><span>(<a href='" + imgDir.Replace("~/", "../") + "' target='_blank'>Mevcut dosya</a> - <a class='DeleteFile' rel='" + reqPage.EventsID + "'  type='EventsImageUrl' href='javascript:void(0)' target='_blank'>Dosyayı Sil</a>)</span></div>";
            }
        }
    }
    if (IsPost)
    {
        if (!AdminLogin.IsLogin())
        {
            Response.Redirect(Shared.PageBasePath() + "Govern/Login");
        }
        // AntiForgery.Validate();
        Events itemPages = new Events();
        EventsHistory backup = new EventsHistory();
        if (Request.QueryString["ID"].IsInt() || Request.QueryString["HistoryID"].IsInt())
        {
            int reqID = Request.QueryString["ID"].AsInt();
            int historyID = (Request.QueryString["HistoryID"].AsInt());
            if (reqID > 0)
            {
                itemPages = ConnXml.Events.FirstOrDefault(x => x.EventsID == reqID);
                int getNewsID = ConnXml.Pages.Where(x => x.ModuleID == 32 && x.Lang == itemPages.Lang).FirstOrDefault().PageID;
                itemPages.LinkUrl = "Page/" + getNewsID + "/" + itemPages.EventsID + "?lang=" + itemPages.Lang;
                backup = itemPages.Cast<EventsHistory>();
            }
            else if (historyID > 0)
            {
                itemPages = ConnXml.EventsHistory.FirstOrDefault(x => x.EventsHistoryID == historyID).Cast<Events>();
                backup = itemPages.Cast<EventsHistory>();
            }
            itemPages.ModifiedDate = DateTime.Now;
            itemPages.ModifiedId = AdminLogin.LoginUserID();
            backup.ModifiedId = AdminLogin.LoginUserID();
        }
        else
        {
            itemPages.CreatedDate = DateTime.Now;
            itemPages.ModifiedDate = DateTime.Now;
            itemPages.CreatedId = AdminLogin.LoginUserID();
            itemPages.ImageUrl = "";
        }
        itemPages.Title = Request.Form["txtTitle"];
        itemPages.Description = Request.Form["txtDesc"];
        itemPages.Contents = Request.Unvalidated()["txtContents"];
        itemPages.RawUrl = itemPages.Title.ConvertToUrl();
        itemPages.PhotoGaleryID = Request.Form["lstPhotoGalery"].AsInt();
        if (Request.Form["txtDate"].ToString().IsEmpty())
        {
            itemPages.Date = DateTime.Now;
        }
        else
        {
            string strDate = Request.Form["txtDate"].ToString();
            DateTime getDate = new DateTime(strDate.Substring(6, 4).AsInt(), strDate.Substring(3, 2).AsInt(), strDate.Substring(0, 2).AsInt());
            itemPages.Date = getDate;
        }
        itemPages.Lang = Request.Form["drpLang"].AsInt();
        itemPages.Status = (Request.Form["drpPageStatus"] == "1" ? true : false);
        if (Request.Files.Count > 0)
        {
            var uploadedFile = Request.Files["fuImageUrl"];
            if (uploadedFile.ContentLength > 0)
            {
                if (!itemPages.ImageUrl.IsEmpty())
                {
                    string imgDir = "~/" + Setting.Documentdir + "/Events/" + itemPages.ImageUrl;
                    System.IO.File.Delete(Server.MapPath(imgDir));
                }
                string getExtentions = Path.GetExtension(uploadedFile.FileName);
                string newFileName = System.Guid.NewGuid().ToString() + getExtentions;
                var fileSavePath = Server.MapPath("~/" + Setting.Documentdir + "/Events/" + newFileName);
                uploadedFile.SaveAs(fileSavePath);
                itemPages.ImageUrl = newFileName;
            }
        }
        int ConnStatus = 0;
        if (Request.QueryString["ID"].IsInt() || Request.QueryString["HistoryID"].IsInt())
        {
            ConnXml.Entry(itemPages).State = System.Data.EntityState.Modified;
            ConnStatus = ConnXml.SaveChanges();
        }
        else
        {
            ConnXml.Events.Add(itemPages);
            ConnStatus = ConnXml.SaveChanges();
            Events reqPageUpdate = ConnXml.Events.FirstOrDefault(x => x.EventsID == itemPages.EventsID);
            int getNewsID = ConnXml.Pages.Where(x => x.ModuleID == 32 && x.Lang == reqPageUpdate.Lang).FirstOrDefault().PageID;
            reqPageUpdate.LinkUrl = "Page/" + getNewsID + "/" + itemPages.EventsID + "?lang=" + reqPageUpdate.Lang;
            ConnXml.Entry(reqPageUpdate).State = System.Data.EntityState.Modified;
            ConnStatus = ConnXml.SaveChanges();
            backup = itemPages.Cast<EventsHistory>();
        }
        if (ConnStatus > 0)
        {
            backup.HistoryCreateDate = DateTime.Now;
            Session["Ok"] = "İşlem başarı ile gerçekleşmiştir.";
            ConnXml.EventsHistory.Add(backup);
            ConnStatus = ConnXml.SaveChanges();
        }
        else
        {
            Session["Error"] = "Bir problem oldu yönetici ile görüşün.";
        }
        Response.Redirect("EventsPage?Lang=" + reqLangID);
    }
}
<div class="Title">@Html.Raw(txtPageTitle)</div>
<form method="post" enctype="multipart/form-data">
    @AntiForgery.GetHtml()
    @* If at least one validation error exists, notify the user *@
    @Html.ValidationSummary("Account creation was unsuccessful. Please correct the errors and try again.", excludeFieldErrors: true, htmlAttributes: null)
    <div id="EditPageContent">
        <div class="Content">
            <div class="Item">
                @HelperAdminControl.inputText("txtTitle", "Başlık", false, true, txtTitle)
                @HelperAdminControl.inputText("txtDesc", "Kısa Açıklama", false, true, txtDesc)
                @HelperAdminControl.inputEditor("txtContents", "Tanım", txtContents)
                @*@HelperAdminControl.inputText("txtRawUrl", "Url", false, true, txtRawUrl)*@
                @HelperAdminControl.fileUpload("fuImageUrl", "Dosya")
                @Html.Raw(fuImageUrl)
                @HelperAdminControl.inputText("txtDate", "Tarih", false, false, txtDate, "Date")
                @{
                    List<SelectListItem> lstGalery = new List<SelectListItem>();
                    lstGalery.Add(new SelectListItem { Value = "0", Text = "Fotoğraf Galeri Kullanma" });
                    lstGalery.AddRange(ConnXml.PhotoGalery.ToList().Select(x => new SelectListItem { Value = x.PhotoGaleryID.ToString(), Text = x.Name, Selected = (x.PhotoGaleryID == lstPhotoGalery.AsInt() ? true : false) }));
                    IEnumerable<SelectListItem> lstGaleryItem = lstGalery;
                    if (lstPhotoGalery != "0")
                    {
                        lstGaleryItem.FirstOrDefault(x => x.Value == lstPhotoGalery).Selected = true;
                    }
                }
                @HelperAdminControl.DropDownList("lstPhotoGalery", "Sayfayla entegre çalışacak fotoğraf galerisi", lstGaleryItem)
                @{
                    List<SelectListItem> lstLang = new List<SelectListItem>();
                    for (int i = 0; i < Shared.Lang.Length; i++)
                    {
                        lstLang.Add(new SelectListItem { Value = i.ToString(), Text = Shared.toLang(i) });
                    }
                    lstLang.FirstOrDefault(x => x.Value == drpLang).Selected = true;
                    IEnumerable<SelectListItem> drplstLangs = lstLang;
                }
                @HelperAdminControl.DropDownList("drpLang", "Dil", drplstLangs)
                <div class="Title">Durum</div>
                <div class="Input">
                    @{
                        string StatusFalse = "";
                        string StatusTrue = "";
                        if (!drpPageStatus)
                        {
                            StatusFalse = "checked='checked'";
                        }
                        else
                        {
                            StatusTrue = "checked='checked'";
                        }
                    }
                    <input type="radio" id="drpPageStatus0" name="drpPageStatus" value="0" @StatusFalse><label for="drpPageStatus0">Pasif</label>
                    <input type="radio" id="drpPageStatus1" name="drpPageStatus" value="1" @StatusTrue><label for="drpPageStatus1">Aktif</label>
                </div>
                <div class="ButtonPanel">
                    <input id="btnSave" name="btnSave" type="submit" class="inputbutton Add" value="@Html.Raw(btnName)" />
                </div>
            </div>
        </div>
    </div>
</form>